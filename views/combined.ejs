<!DOCTYPE html>
<html>
<head>
  <link rel="shortcut icon" href="/img/favicon_57.png"/>
  <link rel="apple-touch-icon" href="/img/favicon_57.png"/>
  <link rel="apple-touch-icon" sizes="72x72" href="/img/favicon_72.png"/>
  <link rel="apple-touch-icon" sizes="114x114" href="/img/favicon_114.png"/>
  <title>NCM & Twilio</title>
  <link rel="stylesheet" href="/css/bell.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
  <script type="text/javascript" src="/js/StartAudioContext.js"></script>
  <script type="text/javascript" src="/js/Tone.js"></script>
  <script type="text/javascript" src="/js/socket.io.slim.js"></script>
  <script type="text/javascript" src="/js/socket.js"></script>
  <script type="text/javascript" src="/js/tonePlayer.js"></script>
  <script type="text/javascript" src="/js/Recorder.js"></script>
  


</head>
<body class="vbox viewport">
  <h1 id="log">Hello</h1>
  <a href="#" id="play" class="button">Play</a>
  <h2>All the songs..........</h2>
</body>

<script>
  const notes = <%- JSON.stringify(notes) %>;
  const genre = `<%- genre %>`;
  const audio = document.querySelector('audio');
  const beat = genre == 'HipHop' ? 'drum_beat' : 'conga_jungle';
  let tapeMachine;
  let player = new TonePlayer(notes);


  Tone.Transport.bpm.value = genre == 'HipHop' ? 90 : 100;
  Tone.Transport.loop = true;
  Tone.Transport.loopStart = 0;
  Tone.Transport.loopEnd = "4m";

  const logStuff = (msg) => {
    $('#log').text(msg);
  }

  const kickOffRecording = async () => {
      tapeMachine = new Recorder(socket, Tone);
      await player.connectStream(tapeMachine.getStream());
      return tapeMachine.start();
  }

  const startSong = async () => {
    await kickOffRecording();
    Tone.Transport.start();
    player.playNote(beat);
    console.log('Starting Song!');
  }

  const resetSong = async() => {
    Tone.Transport.stop();
    player.stopNote(beat);
    await player.disconnectStream(tapeMachine.getStream())
    logStuff('RESET');
    tapeMachine.stop()
  }

  StartAudioContext(Tone.context._context, '#play').then(function(){
    //started
    logStuff('context started');
    // startSong()
  })

  $(document).ready(function () {
    setTimeout(() => {
      console.log(socket);
      socket.on('start_song', () => {
        startSong();
      })

      socket.on('reset_players', () => {
        resetSong();
      })

      socket.on('play_sound', (msg) => {
        logStuff(`${msg.note}: ${msg.action}`);
        console.log(msg);
        if (msg.action == 'stop') {
          player.stopNote(msg.note)
        } else {
          player.playNote(msg.note)
        }
      })

    }, 1000)
  });
</script>
</html>