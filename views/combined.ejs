<!DOCTYPE html>
<html>
<head>
  <link rel="shortcut icon" href="/img/favicon_57.png"/>
  <link rel="apple-touch-icon" href="/img/favicon_57.png"/>
  <link rel="apple-touch-icon" sizes="72x72" href="/img/favicon_72.png"/>
  <link rel="apple-touch-icon" sizes="114x114" href="/img/favicon_114.png"/>
  <title>NCM & Twilio</title>
  <link rel="stylesheet" href="/css/bell.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
  <script type="text/javascript" src="/js/StartAudioContext.js"></script>
  <script type="text/javascript" src="/js/Tone.js"></script>
  <script type="text/javascript" src="/js/socket.io.slim.js"></script>
  <script type="text/javascript" src="/js/socket.js"></script>


</head>
<body class="vbox viewport">
  <h1 id="log">Hello</h1>
  <a href="#" id="play" class="button">Play</a>
  <audio controls download></audio>
  <h2>All the songs..........</h2>

  
</body>
<script>
  const notes = <%- JSON.stringify(notes) %>;
  const genre = `<%- genre %>`;
  const audio = document.querySelector('audio');

  //set the transport
  Tone.Transport.bpm.value = genre == 'HipHop' ? 90 : 100;
  Tone.Transport.loop = true;
  Tone.Transport.loopStart = 0;
  Tone.Transport.loopEnd = "4m";

  const logStuff = (msg) => {
    $('#log').text(msg);
  }

  const kickOffRecording = () => {
    recorder.start();
    setTimeout(() => {
      recorder.stop();
    }, 12000);
  }

  const startSong = () => {
    Tone.Transport.start();
    window['conga_jungle'].mute = false;
    console.log('Starting Song!');
    kickOffRecording();
  }

  const sendAudio = (blb) => {
    const fd = new FormData();
    fd.append('fname', 'test.wav');
    fd.append('data', blb);
    $.ajax({
      url: '/recordings',
      type: 'POST',
      data: fd,
      processData: false,
      // contentType: "audio/wav"
      }).done(function(data) {
      console.log(data);
    });
  }

  StartAudioContext(Tone.context._context, '#play').then(function(){
    //started
    logStuff('context started');
    startSong()
  })

  const chunks = [];
  const actx = Tone.context;
  const dest  = actx.createMediaStreamDestination();
  const recorder = new MediaRecorder(dest.stream);

  recorder.ondataavailable = evt => chunks.push(evt.data);
  recorder.onstop = evt => {
    let blob = new Blob(chunks, { type: 'audio/webm' });
    audio.src = URL.createObjectURL(blob);
    sendAudio(blob);
  };

  for (var i=0; i<notes.length; i++) {
    window[notes[i]] = new Tone.Player({
      url: `/audio/${genre}/${notes[i]}.mp3`,
      loop: true,
      mute: true,
      fadeIn: '4n'
    }).connect(dest).toMaster().sync().start(0);
  }
  

  $(document).ready(function () {
    setTimeout(() => {
      console.log(socket);
      socket.on('start_song', () => {
        startSong();
      })

      socket.on('play_sound', (msg) => {
        logStuff(`${msg.note}: ${msg.action}`);
        console.log(msg);
        window[msg.note].mute = msg.action == 'stop';
      })

    }, 1000)
  });
</script>
</html>